# GPT-2 è’¸é¦ç‰ˆå°æ¨¡å‹è®­ç»ƒä¸éƒ¨ç½² (v3)

æœ¬é¡¹ç›®åŸºäº GPT-2 å¾®è°ƒåçš„ Teacher æ¨¡å‹ï¼Œ  
è®­ç»ƒå‡ºä¸€ä¸ªè‡ªå®šä¹‰å°å‹ Student æ¨¡å‹ï¼ˆå‡å°‘ Transformer å±‚æ•°ï¼‰ï¼Œ  
å¹¶æ”¯æŒæ¨ç†æœåŠ¡éƒ¨ç½²ï¼ˆFlask + ç½‘é¡µç•Œé¢ + Docker æ‰“åŒ…ï¼‰ã€‚

âœ… æœ¬é¡¹ç›®ç‰¹ç‚¹ï¼š
- è‡ªå®šä¹‰å°å‹ GPT-2 Studentï¼ˆ6å±‚ Transformerï¼‰
- å®Œæ•´ Teacher â” Student è’¸é¦è®­ç»ƒæµç¨‹
- æ”¯æŒå•æ¡/æ‰¹é‡æ¨ç†
- æ”¯æŒç½‘é¡µäº¤äº’ï¼ˆè¾“å…¥ promptï¼Œè¿”å›é¢„æµ‹ï¼‰
- æ”¯æŒè½»é‡åŒ– Docker éƒ¨ç½²ï¼ˆGPUç¯å¢ƒï¼‰

---

## ğŸ“‚ ç›®å½•ç»“æ„

```plaintext
PythonProject_GPT2/
â”œâ”€â”€ python1_basic_training/        # âœ… ä¿ç•™æ—§ç‰ˆåŸºç¡€è®­ç»ƒå®éªŒï¼Œæœªåœ¨æœ¬é¡¹ç›®ä¸­ä½¿ç”¨
â”œâ”€â”€ python2_onnx_tensorrt_infer/    # âœ… ä¿ç•™æ—§ç‰ˆONNX+TensorRTåŠ é€Ÿå®éªŒï¼Œæœªåœ¨æœ¬é¡¹ç›®ä¸­ä½¿ç”¨
â”œâ”€â”€ python3_distillation/           # â­ æœ¬é¡¹ç›®æ ¸å¿ƒç›®å½•ï¼ˆå°æ¨¡å‹è’¸é¦ç‰ˆï¼‰
â”‚    â”œâ”€â”€ static/                    # ç½‘é¡µCSSèµ„æº
â”‚    â”œâ”€â”€ templates/                 # ç½‘é¡µHTMLæ¨¡æ¿
â”‚    â”œâ”€â”€ distill_training.py        # gpt2 â” gpt2 è’¸é¦è®­ç»ƒ
â”‚    â”œâ”€â”€ distill_training_v2.py     # gpt2 â” å°gpt2ï¼ˆ6å±‚ï¼‰è’¸é¦è®­ç»ƒ
â”‚    â”œâ”€â”€ distill_infer.py            # gpt2_student æ¨ç†
â”‚    â”œâ”€â”€ distill_infer_v2.py         # gpt2_student_v2 å°æ¨¡å‹æ¨ç†
â”‚    â”œâ”€â”€ distill_api_server.py       # gpt2_student æ¨ç†APIæœåŠ¡
â”‚    â”œâ”€â”€ distill_api_server_v2.py    # gpt2_student_v2 å°æ¨¡å‹æ¨ç†APIæœåŠ¡
â”‚    â”œâ”€â”€ gpt2_student/               # è’¸é¦å¾—åˆ°çš„åŸç”Ÿ student æ¨¡å‹
â”‚    â”œâ”€â”€ gpt2_student_v2/            # è’¸é¦å¾—åˆ°çš„å°å‹ student_v2 æ¨¡å‹
â”œâ”€â”€ Dockerfile_v3.1_backend          # åŸç‰ˆ student é•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ Dockerfile_v3.2_backend          # å°å‹ student_v2 é•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ requirements_v3_backend.txt      # åç«¯ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ README_python3_distillation.md   # ğŸ“„ æœ¬æ–‡ä»¶
â””â”€â”€ ...
```

> ğŸ“Œ è¯´æ˜ï¼š  
> `python1_basic_training/`ã€`python2_onnx_tensorrt_infer/`
> è¿™äº›ç›®å½•ä»…ä¸º**ä¿ç•™æ—§ç‰ˆé¡¹ç›®è®°å½•ï¼Œæœªåœ¨æœ¬è’¸é¦å°æ¨¡å‹é¡¹ç›®ä¸­å®é™…ä½¿ç”¨**ã€‚

---

## ğŸ§© ç‰ˆæœ¬æ¼”è¿›è¯´æ˜

æœ¬é¡¹ç›®åŒ…å«ä¸¤ä¸ªé˜¶æ®µçš„è’¸é¦æ¨¡å‹ï¼š

| ç‰ˆæœ¬ | Studentæ¨¡å‹ç»“æ„ | å‚æ•°è§„æ¨¡ | æ•ˆæœ | æ”¹è¿›ç‚¹ |
|:---|:---|:---|:---|:---|
| v1 | åŸç‰ˆ GPT-2-smallï¼ˆ12å±‚ Transformerï¼‰ | ä¸ Teacher æ¥è¿‘ | è’¸é¦å loss æ˜æ˜¾ä¸‹é™ï¼Œæ¨ç†è¾“å‡ºåˆç†ï¼Œä½†æ¨¡å‹ä½“ç§¯è¾ƒå¤§ | æ‰“é€šè’¸é¦è®­ç»ƒ-æ¨ç†-éƒ¨ç½²å®Œæ•´æµç¨‹ |
| v2 | è‡ªå®šä¹‰å°å‹ GPT-2ï¼ˆ6å±‚ Transformerï¼‰ | å‚æ•°é‡å‡å°‘çº¦50% | è’¸é¦åæ¨ç†é€Ÿåº¦æ›´å¿«ï¼Œä½†é¢„æµ‹è´¨é‡æœ‰æ‰€ä¸‹é™ï¼ˆå› æ¨¡å‹å°ã€è®­ç»ƒæ•°æ®å°‘ï¼‰ | æˆåŠŸå®ç°å°å‹åŒ– Studentï¼Œæ¨ç†éƒ¨ç½²æ›´è½»é‡ |

---

âœ… v1é˜¶æ®µï¼š
- å®Œæ•´å¤ç°äº† Teacher â” Student è’¸é¦åŸºç¡€æµç¨‹
- Student ä¸ Teacher ç»“æ„å¤§å°æ¥è¿‘
- é‡ç‚¹éªŒè¯æŠ€æœ¯é—­ç¯ï¼ˆè®­ç»ƒã€æ¨ç†ã€APIéƒ¨ç½²ï¼‰

âœ… v2é˜¶æ®µï¼š
- è‡ªå®šä¹‰å°æ¨¡å‹ï¼ˆ6å±‚ Transformerï¼‰
- æ¨¡å‹ä½“ç§¯å‡å°ï¼Œæ¨ç†é€Ÿåº¦æå‡
- æˆåŠŸæ‰“é€šå°æ¨¡å‹è’¸é¦è®­ç»ƒã€æ¨ç†ã€ç½‘é¡µéƒ¨ç½²å…¨æµç¨‹

ğŸ“Œ å½“å‰ Docker éƒ¨ç½²ç‰ˆæœ¬ä¸º **v2ç‰ˆï¼ˆå°æ¨¡å‹ student_v2ï¼‰**ï¼Œå³è¿è¡Œ `distill_api_server_v2.py`ã€‚

---

## ğŸš€ å°æ¨¡å‹è’¸é¦è®­ç»ƒæµç¨‹æ¦‚è§ˆ

1. ä½¿ç”¨å¾®è°ƒåçš„ GPT-2 ä½œä¸º Teacher
2. å®šä¹‰å°å‹ Studentï¼ˆå‡å°‘ Transformer å±‚æ•°ï¼‰
3. Teacher ç”Ÿæˆ soft targetï¼ŒStudent é€šè¿‡ KL æ•£åº¦å­¦ä¹ 
4. ä¿å­˜ Student æ¨¡å‹ï¼Œä¾›æ¨ç†æœåŠ¡è°ƒç”¨
5. å°è£…æ¨ç†æ¥å£ï¼Œæ”¯æŒç½‘é¡µè°ƒç”¨æˆ–APIè®¿é—®

---

## ğŸ› ï¸ Docker æ„å»ºä¸è¿è¡ŒæŒ‡å—

æœ¬é¡¹ç›®æä¾›ä¸¤ç‰ˆ Docker éƒ¨ç½²ï¼š

| ç‰ˆæœ¬ | é•œåƒæ–‡ä»¶ | è¿è¡Œçš„APIæœåŠ¡ | è¯´æ˜ |
|:---|:---|:---|:---|
| v1 | Dockerfile_v3.1_backend | distill_api_server.py | åŸç‰ˆ Studentï¼ˆgpt2_studentï¼‰æ¨ç† |
| v2 | Dockerfile_v3.2_backend | distill_api_server_v2.py | å°æ¨¡å‹ Studentï¼ˆgpt2_student_v2ï¼‰æ¨ç† |

---

### ğŸ“¦ v1ç‰ˆï¼ˆåŸç‰ˆ Studentï¼Œgpt2_studentï¼‰

#### 1. æ„å»º Docker é•œåƒ

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd PythonProject_GPT2/

# ä½¿ç”¨ Dockerfile_v3.1_backend æ„å»º v1ç‰ˆé•œåƒ
docker build -f Dockerfile_v3.1_backend -t gpt2-distill-backend-v1 .
```

#### 2. è¿è¡Œ Docker å®¹å™¨

```bash
docker run -it --rm -p 6006:6006 gpt2-distill-backend-v1
```

#### 3. è®¿é—®æ¨ç†ç½‘é¡µ

æµè§ˆå™¨è®¿é—®ï¼š

```plaintext
http://localhost:6006/
```

è¾“å…¥ promptï¼Œè¿”å›åŸç‰ˆ studentï¼ˆgpt2_studentï¼‰çš„é¢„æµ‹ç»“æœï¼

---

### ğŸ“¦ v2ç‰ˆï¼ˆå°æ¨¡å‹ Studentï¼Œgpt2_student_v2ï¼‰

#### 1. æ„å»º Docker é•œåƒ

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd PythonProject_GPT2/

# ä½¿ç”¨ Dockerfile_v3.2_backend æ„å»º v2ç‰ˆé•œåƒ
docker build -f Dockerfile_v3.2_backend -t gpt2-distill-backend-v2 .
```

#### 2. è¿è¡Œ Docker å®¹å™¨

```bash
docker run -it --rm -p 6006:6006 gpt2-distill-backend-v2
```

#### 3. è®¿é—®æ¨ç†ç½‘é¡µ

æµè§ˆå™¨è®¿é—®ï¼š

```plaintext
http://localhost:6006/
```

è¾“å…¥ promptï¼Œè¿”å›å°æ¨¡å‹ studentï¼ˆgpt2_student_v2ï¼‰çš„é¢„æµ‹ç»“æœï¼

---

ğŸ“Œ **æ³¨æ„äº‹é¡¹ï¼š**
- v1å’Œv2å…±ç”¨ç›¸åŒç«¯å£ï¼ˆ6006ï¼‰ï¼Œå› æ­¤**åŒæ—¶åªèƒ½è¿è¡Œä¸€ä¸ªç‰ˆæœ¬**ï¼
- é•œåƒååˆ†åˆ«æ˜¯ `gpt2-distill-backend-v1` å’Œ `gpt2-distill-backend-v2`ï¼Œé¿å…æ··æ·†ã€‚

---

## ğŸ“¸ ç¤ºä¾‹æ•ˆæœæˆªå›¾

![Web Chat](sample_images/distillation.png)

---

## ğŸ“Œ æŠ€æœ¯æ ˆç‰ˆæœ¬

| æŠ€æœ¯ | ç‰ˆæœ¬ |
|:---|:---|
| PyTorch | 2.1.0 |
| CUDA | 11.8 |
| transformers | 4.x æœ€æ–°ç‰ˆ |
| Flask | æœ€æ–°ç‰ˆ |
| Python | 3.11 |

---

## âœ¨ åç»­æ‰©å±•æ–¹å‘

- ã€å‰ªæç‰ˆã€‘åœ¨å° student_v2 æ¨¡å‹åŸºç¡€ä¸Šè¿›è¡Œç¨€ç–å‰ªæï¼Œè¿›ä¸€æ­¥å‹ç¼©æ¨¡å‹
- ã€é‡åŒ–ç‰ˆã€‘åœ¨å°æ¨¡å‹åŸºç¡€ä¸Šè¿›è¡Œ int8 é‡åŒ–æ¨ç†åŠ é€Ÿ
- ã€æ•°æ®å¢å¼ºã€‘æ‰©å……è®­ç»ƒé›†ï¼Œè¿›ä¸€æ­¥æå‡å°æ¨¡å‹æ¨ç†è´¨é‡

---
